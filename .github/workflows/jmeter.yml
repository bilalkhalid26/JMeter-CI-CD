name: JMeter Performance Test

on:
  push:
    branches: [ main ]

jobs:
  jmeter-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip
          unzip apache-jmeter-5.6.3.zip

      - name: Run JMeter Test
        run: ./apache-jmeter-5.6.3/bin/jmeter -n -t MyTest.jmx -l results.jtl

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results.jtl

    - name: Send Mail on Failure
        if: failure() # Sirf tab chalega jab JMeter test fail hoga
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_APP_PASSWORD }}
          subject: "üö® ALERT: JMeter Test Failed! (Check Results)"
          to: "alkhalidplumbing@gmail.com"
          from: "QA Automation Bot"
          html_body: |
            <h2>Oho! Test Fail Ho Gaya! ü§¶‚Äç‚ôÇÔ∏è</h2>
            <p>Bilal ki script ne error pakad liya hai. Wajhee Bhai, lagta hai code mein koi masla hai!</p>
            <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGJueXp3bm94bm94bm94bm94bm94JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/26tp16vX3D26XJ93u/giphy.gif" width="300" />
            <br>
            <p><b>Status:</b> Failed ‚ùå</p>
            <p>Aap report GitHub Actions se download kar sakte hain.</p>